generator client {
  provider = "prisma-client-js"
}

// Production: PostgreSQL
// Usage:
// 1. Copy this file to schema.prisma (or set PRISMA_SCHEMA_PATH)
// 2. Set DATABASE_URL=postgresql://user:pass@host:5432/wrootz in .env
// 3. Run: npx prisma generate
// 4. Run: npx prisma migrate deploy
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String   @id @default(cuid())
  username      String   @unique
  password      String   // hashed
  bio           String?  @db.Text
  avatarUrl     String?

  // Wallet connection (real BSV)
  walletAddress String?  @unique
  walletType    String?

  // NOTE: balance and lockedAmount are now tracked on-chain
  // These fields are kept for caching/display purposes only
  cachedBalance     Float    @default(0.0)
  cachedLockedAmount Float   @default(0.0)

  isAdmin       Boolean  @default(false)
  displayUnit   String   @default("sats")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  posts         Post[]   @relation("PostCreator")
  ownedPosts    Post[]   @relation("PostOwner")
  locks         Lock[]
  transactions  Transaction[]
  followedTags  FollowedTag[]
  followedUsers FollowedUser[] @relation("Follower")
  followers     FollowedUser[] @relation("Following")
  notifications Notification[] @relation("NotificationRecipient")
  hiddenPosts   HiddenPost[]
}

model Notification {
  id        String   @id @default(cuid())
  type      String
  message   String   @db.Text
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  userId    String
  user      User     @relation("NotificationRecipient", fields: [userId], references: [id], onDelete: Cascade)
  postId    String?
  post      Post?    @relation(fields: [postId], references: [id], onDelete: Cascade)
  actorId   String?
}

model Post {
  id                    String   @id @default(cuid())
  title                 String
  body                  String   @db.Text
  imageUrl              String?
  videoUrl              String?
  lockerSharePercentage Float    @default(10.0)
  forSale               Boolean  @default(false)
  salePrice             Float    @default(0.0)
  listedAt              DateTime?
  totalTu               Float    @default(0.0)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // 1Sat Ordinal fields
  inscriptionId   String?  @unique
  inscriptionTxid String?
  contentHash     String?

  // Relations
  creatorId     String
  creator       User     @relation("PostCreator", fields: [creatorId], references: [id])
  ownerId       String
  owner         User     @relation("PostOwner", fields: [ownerId], references: [id])
  locks         Lock[]
  transactions  Transaction[]
  notifications Notification[]

  outgoingLinks PostLink[] @relation("LinksFrom")
  incomingLinks PostLink[] @relation("LinksTo")
  hiddenBy      HiddenPost[]

  @@index([inscriptionId])
  @@index([ownerId, forSale])
}

model PostLink {
  id           String   @id @default(cuid())
  type         String   @default("reply")
  createdAt    DateTime @default(now())

  sourcePostId String
  sourcePost   Post     @relation("LinksFrom", fields: [sourcePostId], references: [id], onDelete: Cascade)

  targetPostId String
  targetPost   Post     @relation("LinksTo", fields: [targetPostId], references: [id], onDelete: Cascade)

  creatorId    String

  @@unique([sourcePostId, targetPostId])
  @@index([targetPostId])
}

model Lock {
  id             String   @id @default(cuid())
  amount         Float
  satoshis       Int
  durationBlocks Int
  startBlock     Int
  remainingBlocks Int
  initialTu      Float
  currentTu      Float
  tag            String?
  expired        Boolean  @default(false)

  // On-chain tracking
  txid           String?
  lockAddress    String?
  unlockTxid     String?
  confirmed      Boolean  @default(false)

  // Blockchain verification
  verified       Boolean  @default(false)
  verifiedAt     DateTime?
  onChainAmount  Int?
  onChainUnlock  Int?

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  userId    String
  user      User   @relation(fields: [userId], references: [id])
  postId    String
  post      Post   @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([txid])
  @@index([userId, postId])
  @@index([expired, startBlock])
  @@index([tag])
}

model Transaction {
  id           String   @id @default(cuid())
  action       String
  amount       Float
  satoshis     Int?
  description  String?  @db.Text

  txid         String?
  confirmed    Boolean  @default(false)
  blockHeight  Int?

  createdAt    DateTime @default(now())

  userId  String
  user    User   @relation(fields: [userId], references: [id])
  postId  String?
  post    Post?  @relation(fields: [postId], references: [id], onDelete: SetNull)

  @@index([txid])
}

model BlockchainState {
  id              String   @id @default("singleton")
  currentBlock    Int      @default(0)
  lastSyncTime    DateTime @default(now())
  network         String   @default("mainnet")
}

model FollowedTag {
  id        String   @id @default(cuid())
  tag       String
  createdAt DateTime @default(now())

  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, tag])
}

model FollowedUser {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  followerId  String
  follower    User   @relation("Follower", fields: [followerId], references: [id], onDelete: Cascade)
  followingId String
  following   User   @relation("Following", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
}

model HiddenPost {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  postId    String
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
}

model AdminAuditLog {
  id          String   @id @default(cuid())
  action      String
  details     String   @db.Text
  targetType  String?
  targetId    String?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())

  adminId     String

  @@index([adminId])
  @@index([action])
  @@index([createdAt])
}
