# Wrootz BRC-100 â€” Review #9 (v9 / 2026-02-17)

**Reviewer:** Claude Sonnet 4.6
**Date:** 2026-02-17
**Scope:** Full codebase post-v8 fixes â€” all phases (Security, Bugs, Architecture, Quality)
**Rating:** 9.5 / 10

---

## Pre-Review Status

| Check | Result |
|-------|--------|
| ESLint | âœ… No warnings or errors |
| TypeScript | âœ… No type errors |
| Tests | âœ… 212/212 passing (8 test files) |

All toolchain checks pass. REVIEW_FINDINGS.md entered this review with 0 open issues (55 prior findings all resolved in v5â€“v8). This review focuses on new findings only.

---

## Executive Summary

The codebase remains in excellent health. Seven new findings were identified â€” none are Critical or High severity. The two most actionable are a missing database index on `Post.ownerId` (medium performance risk as the post table grows) and the deprecated `lockBSV` stub still being exported from the public barrel file. The security findings are latent/low-severity; the rate limiter and wallet session TTL are both correctly fail-closed in the paths that actually execute.

---

## Phase 1: Security

### S-NEW-1 (Medium) â€” Cron endpoints are unprotected in non-production environments

**Files:**
- `app/api/cron/update-locks/route.ts:37â€“39`
- `app/api/cron/confirm-transactions/route.ts:40â€“42`

When `CRON_SECRET` is absent (the common case in dev, CI, and Vercel preview deployments), both cron endpoints log a warning and execute without authentication. An attacker with access to a preview URL can:

1. Call `GET /api/cron/update-locks` to force-expire locks ahead of schedule
2. Call `GET /api/cron/confirm-transactions` to artificially confirm pending transactions

**Root cause:** The guard on line 29 (`if (!cronSecret && NODE_ENV === 'production')`) returns 500 only in production. Lines 37â€“39 only `console.warn` in all other environments.

**Recommended fix:**
```typescript
// Both cron endpoints â€” require the secret in ALL environments, not just production
if (!cronSecret) {
  return NextResponse.json({ error: 'CRON_SECRET is required' }, { status: 401 })
}
```
If you want open dev endpoints, gate on an explicit `ALLOW_OPEN_CRON=true` env flag instead of relying on `NODE_ENV !== 'production'`.

---

### S-NEW-2 (Low) â€” `getWalletToken()` / `getWalletIdentityKey()` bypass the 24-hour TTL

**File:** `app/lib/wallet-session.ts:106â€“117`

Both exported helpers call `getWalletSession()` directly (no TTL enforcement) rather than `getValidWalletSession()`. If either function is imported in a future feature without the author checking the TTL semantics, operations could succeed on a session older than 2 hours (cookie expired) but within 24 hours (absolute max still valid).

**Currently unexploited** â€” a codebase-wide grep confirms neither function is called anywhere outside `wallet-session.ts`. But they are exported dead code that invites future misuse.

**Recommended fix:** Either delete both functions (they have no callers), or change them to delegate to `getValidWalletSession()`:
```typescript
export async function getWalletToken(): Promise<string | null> {
  const session = await getValidWalletSession()
  return session?.sessionToken ?? null
}
```

---

### S-NEW-3 (Low) â€” Misleading log when Redis rate limiter errors in production

**File:** `app/lib/rate-limit-core.ts:113â€“120`

When Redis throws (line 113), the code logs "falling back to in-memory" and calls `checkInMemoryLimit()`. In production, `checkInMemoryLimit` immediately returns `{allowed: false}` for every request (line 71â€“72), so the security outcome is correct (fail-closed). However the log message implies a partial fallback is happening, which is misleading for incident response.

**Recommended fix:** Add a production-aware log message:
```typescript
} catch (error) {
  if (process.env.NODE_ENV === 'production') {
    console.error('Redis rate limit error â€” failing closed (all requests denied):', error)
  } else {
    console.error('Redis rate limit error, falling back to in-memory:', error)
  }
}
```

---

## Phase 2: Bugs

### B-NEW-1 (Medium) â€” Deprecated `lockBSV` stub still exported from public barrel

**Files:** `app/actions/posts/index.ts:8`, `app/actions/posts/locks.ts:18â€“20`

The `lockBSV` function is marked `@deprecated` and returns only an error string, but it is still re-exported from the barrel (`index.ts:8`). Any consumer that imports from `@/app/actions/posts` sees it as valid API surface. The concern is not runtime breakage (it's a safe no-op stub), but the export signals that the function is supported, and a future developer may call it expecting it to work.

**Recommended fix:** Remove `lockBSV` from `index.ts:8`:
```typescript
// Before:
export { lockBSV, recordLock, tipPost } from './locks'
// After:
export { recordLock, tipPost } from './locks'
```
The `lockBSV` function and its `eslint-disable` comment in `locks.ts` can be deleted entirely once confirmed no external callers exist.

---

### B-NEW-2 (Medium) â€” `Post` model missing index on `ownerId` (and compound `ownerId, forSale`)

**File:** `prisma/schema.prisma:89â€“100`

`Post` has `@@index([inscriptionId])` but no index on `ownerId`. Two common query patterns lack an index:
1. Profile page: `prisma.post.findMany({ where: { ownerId: userId } })`
2. For-sale feed filter: `conditions.push({ forSale: true })` â€” which is often combined with `ownerId`

As the post table grows, both will cause full table scans.

**Recommended fix:**
```prisma
@@index([inscriptionId])
@@index([ownerId, forSale])  // Add this
```

---

### B-NEW-3 (Low) â€” `EditProfileButton` useEffect intentionally omits prop deps

**File:** `app/components/EditProfileButton.tsx:25â€“35`

The `eslint-disable-line react-hooks/exhaustive-deps` comment intentionally omits `currentBio` and `currentAvatarUrl` so the form only resets on `isOpen` toggle (not on every parent render). The intent is correct. However, if the parent re-renders with updated prop values *while the modal is open*, closing and reopening will reset to the stale values captured at open time. This is only observable if a concurrent background update changes the profile during an active edit session.

No code change needed â€” noting for awareness.

---

### B-NEW-4 (Low) â€” `TipForm` setTimeout has no cleanup handle

**File:** `app/components/TipForm.tsx:57â€“59`

The 3-second success-state reset timer is not stored and cannot be cleared on unmount. The `mountedRef.current` guard prevents a state-update-on-unmounted-component error, but the timer runs to completion in the background. This is benign in practice.

**Recommended fix (optional):**
```typescript
const timerRef = useRef<ReturnType<typeof setTimeout> | null>(null)
// ...
timerRef.current = setTimeout(() => {
  if (mountedRef.current) setSuccess(false)
}, 3000)

// In a useEffect cleanup:
useEffect(() => () => { if (timerRef.current) clearTimeout(timerRef.current) }, [])
```

---

## Phase 3: Architecture

### A-NEW-1 (Medium) â€” Rising-feed fetches 500 posts into memory on every paginated request

**File:** `app/actions/posts/queries.ts:90â€“172`

The `getRisingPosts(500)` pool-then-cursor pattern was chosen to support stable ordered pagination across the rising feed. The trade-off is that every page request (including page 2, 3â€¦) re-executes the full 500-post aggregate query. With a small post count this is fast, but it scales linearly with post volume.

**Options when this becomes a bottleneck:**
1. Cache the rising-pool IDs in Redis with a short TTL (e.g. 60 seconds), serving paginated slices from the cache
2. Materialize a `recentWrootzGain` field on `Post` and query it directly with DB-level pagination
3. Accept the current approach with a `take: 200` cap until scale justifies the change

No immediate action needed â€” document the known scalability limit with a `// TODO(scale)` comment.

---

### A-NEW-2 (Low) â€” `Post.totalTu` is a stale DB cache requiring post-query correction

**File:** `app/actions/posts/queries.ts:275â€“278`

The H5 comment acknowledges that `totalTu` stored in the DB is stale and re-sorts in-memory after fetching. This dual-maintenance pattern (DB cached field + live recalculation from lock rows) is a known architectural tension. No action needed now, but if the mismatch ever causes incorrect ranking in a hot path, the field should either become authoritative (transactionally updated) or be removed in favour of always computing it.

---

## Phase 4: Code Quality

### Q-NEW-1 (Low) â€” No React component tests

All 212 tests are utility/unit tests. There are no component-level tests (no jsdom setup, no React Testing Library). Critical interactive flows â€” `LockForm` submission, `SaleActions` wallet connection, `WalletProvider` state management â€” are only covered by manual testing. Consider adding at least smoke tests for the two wallet-touching forms.

---

## Summary of New Findings

| ID | Severity | Category | File | Issue |
|----|----------|----------|------|-------|
| S-NEW-1 | ðŸŸ  Medium | Security | `api/cron/*/route.ts:37` | Cron endpoints unprotected outside production |
| S-NEW-2 | âšª Low | Security | `wallet-session.ts:106` | Exported helpers bypass 24h TTL (no callers, latent) |
| S-NEW-3 | âšª Low | Security | `rate-limit-core.ts:114` | Misleading log on Redis error (correct behaviour, wrong message) |
| B-NEW-1 | ðŸŸ¡ Medium | Bug | `posts/index.ts:8` | Deprecated `lockBSV` still exported from barrel |
| B-NEW-2 | ðŸŸ¡ Medium | Bug | `schema.prisma:89` | `Post.ownerId` missing DB index |
| B-NEW-3 | âšª Low | Bug | `EditProfileButton.tsx:35` | Intentional stale-props in useEffect (awareness only) |
| B-NEW-4 | âšª Low | Bug | `TipForm.tsx:57` | setTimeout not cleared on unmount (benign) |
| A-NEW-1 | ðŸŸ¡ Medium | Architecture | `queries.ts:90` | Rising feed: 500-post in-memory pool on every page |
| A-NEW-2 | âšª Low | Architecture | `queries.ts:275` | `Post.totalTu` dual-maintenance pattern |
| Q-NEW-1 | âšª Low | Quality | `app/lib/__tests__/` | No React component tests |

---

## Prioritised Remediation

### Before Next Release (1 medium security risk)
1. **S-NEW-1** `api/cron/*/route.ts` â€” Require `CRON_SECRET` in all environments. **Effort: quick**

### Next Sprint
2. **B-NEW-2** `schema.prisma` â€” Add `@@index([ownerId, forSale])` to `Post`. **Effort: quick** (migration needed)
3. **B-NEW-1** `posts/index.ts` â€” Remove `lockBSV` from barrel export and delete the stub. **Effort: quick**

### Backlog
4. **S-NEW-2** `wallet-session.ts` â€” Delete or fix `getWalletToken`/`getWalletIdentityKey`. **Effort: quick**
5. **A-NEW-1** `queries.ts` â€” Add `// TODO(scale)` comment on rising pool pattern; plan cache strategy. **Effort: quick (comment), medium (implementation)**
6. **Q-NEW-1** â€” Bootstrap React component tests for LockForm and SaleActions. **Effort: major**

---

## Overall Assessment

**Rating: 9.5 / 10** â€” unchanged from v8. The codebase is in excellent shape. The seven new findings are predominantly low-severity latent issues or deliberate trade-offs. The one actionable item before the next release is locking down the cron endpoints in all environments (S-NEW-1).
