# Wrootz BRC-100 Code Review Findings

**Date:** 2026-02-17 (Review #5 — Full Parallel, 4-Phase)
**Reviewer:** Claude Opus 4.6
**Scope:** 32 modified files in working tree vs HEAD
**Previous:** Review #4 (2026-02-17, 50 findings, 6.5/10)

## Overall Health Rating: 7/10

Significant improvement from Review #4. Many previously identified critical issues have been addressed: session secret hardening, password policy upgrade, username validation, rate limiting on upload/verify endpoints, admin capability removal, and information leakage reduction in blockchain verification. The codebase now has 64 passing tests across 4 test files.

However, serious issues remain. The buy flow has a stale closure crash that will cause a `TypeError` every time a disconnected user tries to buy. The seller wallet address is exposed client-side, creating a TOCTOU payment redirection risk. Transaction ID validation allows SSRF. And SaleActions has a two-phase commit pattern (send money, then confirm on server) with no recovery mechanism if the server call fails.

---

## Pre-Review Status

| Check | Status |
|-------|--------|
| ESLint | No warnings or errors |
| TypeScript | No type errors |
| Tests | 64/64 passing (4 test files) |

---

## Phase 1: Security Audit

### CRITICAL

#### S1. Missing txid hex validation enables SSRF
- **Files:** `app/actions/posts/sales.ts:194`, `app/lib/blockchain-verify.ts:71`
- **Description:** `buyPost` validates `txid.length !== 64` but does NOT verify hex-only characters. The txid is interpolated into a WhatsOnChain API URL: `fetch(\`${WHATSONCHAIN_API}/tx/${txid}\`)`. A 64-char string with path traversal characters could manipulate the API path.
- **Fix:** Add `/^[0-9a-f]+$/i` validation.
- **Effort:** Quick fix

### HIGH

#### S2. Seller wallet address exposed client-side — TOCTOU payment redirection
- **Files:** `app/actions/posts/queries.ts:297`, `app/post/[id]/PostPageClient.tsx:276`, `app/post/[id]/SaleActions.tsx:99`
- **Description:** The seller's `walletAddress` is embedded in HTML props and used in client-side `sendBSV()`. A tampered client could modify `sellerAddress` before payment, sending funds to an attacker's address. The server verifies the txid afterward, but the on-chain payment is already irreversible.
- **Fix:** Do not expose `walletAddress` to the client. Have the server construct the transaction with the correct recipient, or fetch seller address server-side at purchase time.
- **Effort:** Medium refactor

#### S3. Wallet session 30-day TTL with no re-auth for sensitive operations
- **Files:** `app/lib/wallet-session.ts:44`
- **Description:** A wallet session handling real BSV transactions lasts 30 days. The `connectedAt` field is stored but never enforced.
- **Fix:** Reduce TTL to 4-8 hours. Enforce `connectedAt` checks. Force re-auth before sensitive operations.
- **Effort:** Medium refactor

#### S4. Wallet session password has no minimum length validation
- **Files:** `app/lib/wallet-session.ts:29-35`
- **Description:** Unlike `session.ts` which validates `secret.length < 32`, wallet-session only checks existence. A 1-character secret weakens iron-session encryption.
- **Fix:** Add `secret.length < 32` check matching `session.ts`.
- **Effort:** Quick fix

### MEDIUM

#### S5. SaleActions buy flow: no client-side double-submit protection
- **Files:** `app/post/[id]/SaleActions.tsx:69-116`
- **Description:** `setLoading(true)` is set after wallet connection checks (line 94), creating a window where rapid clicks could trigger multiple `sendBSV` calls.
- **Fix:** Set `loading` to `true` at the very start of `handleBuy`.
- **Effort:** Quick fix

#### S6. In-memory rate limiting fails open in production
- **Files:** `app/lib/rate-limit-core.ts:27-40`
- **Description:** When Redis is unavailable, rate limiting falls back to an in-memory `Map`. In serverless deployments, each invocation gets its own process, making the store useless.
- **Fix:** Fail closed (reject requests) when Redis is unavailable in production for critical endpoints.
- **Effort:** Quick fix

#### S7. Rate limit IP extraction trusts client-controlled headers
- **Files:** `app/lib/rate-limit-core.ts:119-125`
- **Description:** `extractClientIP` trusts `x-forwarded-for`, `x-real-ip`, and `cf-connecting-ip` without verifying they come from trusted proxies.
- **Fix:** Only trust headers from verified proxies/CDN.
- **Effort:** Medium refactor

#### S8. Lock amount tolerance exploitable on small amounts
- **Files:** `app/lib/blockchain-verify.ts:292`
- **Description:** 100-sat tolerance represents 10-18% discrepancy near the dust limit (546-1000 sats). Could be exploited to systematically underpay.
- **Fix:** Use percentage-based tolerance, or only tolerate underpayment (not overpayment direction).
- **Effort:** Quick fix

### LOW

#### S9. `console.error` in blockchain-verify leaks txid to server logs
- **Files:** `app/lib/blockchain-verify.ts:83`

#### S10. ErrorBoundary logs full error details to console in production
- **Files:** `app/components/ErrorBoundary.tsx:25-28`

---

## Phase 2: Bug Detection

### CRITICAL

#### B1. Stale `currentWallet` null crash in SaleActions
- **Files:** `app/post/[id]/SaleActions.tsx:79-99`
- **Description:** When a disconnected user clicks "Buy", `connect()` sets `currentWallet` via React state, but the closure-captured value remains `null`. Line 99 calls `currentWallet!.sendBSV(...)` on null, causing a `TypeError` crash.
- **Fix:** Have `connect()` return the adapter instance directly, or require connection before showing the form.
- **Effort:** Quick fix

#### B2. Same stale `currentWallet` bug in LockForm
- **Files:** `app/components/LockForm.tsx:41-75`
- **Description:** Identical to B1. `currentWallet!.lockBSV(...)` on line 75 crashes if `connect()` was just called.
- **Fix:** Same as B1.
- **Effort:** Quick fix

#### B3. SatsInput max=0 clamps all input to 0
- **Files:** `app/components/SatsInput.tsx:49-52`
- **Description:** When `userBalanceSats` is 0 (balance not loaded), `max=0` is passed. The clamping logic converts any typed value to "0", making the input field completely unusable.
- **Fix:** Only clamp when `max > 0`, or don't pass `max` when balance is 0.
- **Effort:** Quick fix

### HIGH

#### B4. Session/wallet-session crash in dev without SESSION_SECRET
- **Files:** `app/lib/session.ts:13-14`, `app/lib/wallet-session.ts:31-32`
- **Description:** Dev fallback removed; app crashes immediately on startup if env var missing. Intentional security hardening but breaking for developers.
- **Fix:** Update `.env.example` with `SESSION_SECRET` generation instructions.
- **Effort:** Quick fix

#### B5. LockForm NaN bypass in custom blocks validation
- **Files:** `app/components/LockForm.tsx:56-59`
- **Description:** `parseInt('')` returns `NaN`. `NaN < 1` is `false` and `NaN > max` is `false`, so NaN passes validation.
- **Fix:** Add `isNaN(blocks)` check.
- **Effort:** Quick fix

#### B6. Verify route `fullyVerified` always false for >50 locks
- **Files:** `app/api/verify/post/[id]/route.ts:69,141-143`
- **Description:** Verifies max 50 locks but compares `verifiedLocks.length` against total `post.locks.length`.
- **Fix:** Compare against `locksToVerify.length` and add `partialVerification` flag.
- **Effort:** Quick fix

### MEDIUM

#### B7. Password policy tests don't exercise common password rejection
- **Files:** `app/lib/__tests__/password-policy.test.ts:32-37`
- **Description:** All common password test cases are 7-8 characters, so they fail on length before reaching the common-password check.
- **Fix:** Add test cases for 12+ char common passwords.
- **Effort:** Quick fix

#### B8. `router.refresh()` called in `finally` block even on payment failure
- **Files:** `app/post/[id]/SaleActions.tsx:118-122`
- **Fix:** Move to success path only.
- **Effort:** Quick fix

#### B9. `handleList` and `handleCancel` have no try/catch
- **Files:** `app/post/[id]/SaleActions.tsx:28-52, 54-68`
- **Description:** If server actions throw, `loading` is never reset, leaving the UI stuck.
- **Fix:** Wrap in try/catch/finally.
- **Effort:** Quick fix

#### B10. Password-policy docstring says "Minimum 8 characters" but code requires 12
- **Files:** `app/lib/password-policy.ts:5`
- **Effort:** Quick fix

---

## Phase 3: Architecture Review

### CRITICAL

#### A1. SaleActions buy flow: payment sent but server confirmation can fail
- **Files:** `app/post/[id]/SaleActions.tsx:97-113`
- **Description:** `handleBuy` sends real BSV via `sendBSV()`, then calls `buyPost()` on the server. If the wallet send succeeds but the server call fails (network error, server crash, rate limit), the buyer has sent money but ownership was never transferred. The transaction ID is lost in the error state.
- **Fix:** Persist txid locally after `sendBSV` succeeds. Display txid to user in error state. Add "pending purchases" recovery mechanism. Distinguish wallet-send failures from server-confirmation failures.
- **Effort:** Medium refactor

#### A2. `isRedisAvailable()` is dead code
- **Files:** `app/lib/server-action-rate-limit.ts:78-80`
- **Description:** No callers exist in the codebase. Checks `authRateLimiter !== null` rather than actual Redis availability.
- **Fix:** Remove the function, or import `redis` from `rate-limit-core.ts` directly.
- **Effort:** Quick fix

### HIGH

#### A3. Duplicate Redis client instances
- **Files:** `app/lib/idempotency.ts:15`, `app/lib/rate-limit-core.ts:11`
- **Description:** `idempotency.ts` creates its own `new Redis()` while `rate-limit-core.ts` has a shared one.
- **Fix:** Import `redis` from `rate-limit-core.ts`.
- **Effort:** Quick fix

#### A4. SaleActions missing `mountedRef` guard
- **Files:** `app/post/[id]/SaleActions.tsx`
- **Description:** LockForm and TipForm use `mountedRef` pattern to prevent state updates on unmounted components. SaleActions does the same async pattern but lacks this protection.
- **Fix:** Add `mountedRef` pattern matching LockForm.
- **Effort:** Quick fix

#### A5. In-memory stores fail silently in serverless production
- **Files:** `app/lib/rate-limit-core.ts:28`, `app/lib/idempotency.ts:23,156`
- **Description:** Module-level `Map`/`Set` fallbacks reset per invocation in serverless. Financial operations fail-open without Redis.
- **Fix:** Fail closed in production. Document that in-memory fallback is development-only.
- **Effort:** Quick fix

### MEDIUM

#### A6. Timer leak in `rate-limit-core.ts`
- **Files:** `app/lib/rate-limit-core.ts:31-39`
- **Description:** `setInterval` reference never stored, can't be cleared. Leaks timers in test/HMR scenarios.
- **Fix:** Store reference, export `cleanup()` function.
- **Effort:** Quick fix

#### A7. Type assertion smell for `sellerAddress`
- **Files:** `app/post/[id]/PostPageClient.tsx:276`
- **Description:** `(post.owner as { walletAddress?: string | null }).walletAddress` — type cast needed because Post type doesn't include `walletAddress`.
- **Fix:** Update Post type definition.
- **Effort:** Quick fix

#### A8. Password min length 8→12 migration risk
- **Files:** `app/lib/password-policy.ts`, `app/(auth)/register/page.tsx`
- **Description:** If `validatePassword` is called during login, existing users with 8-11 char passwords would be locked out.
- **Fix:** Verify validation only runs on registration/password-change, not login.
- **Effort:** Quick fix (verification)

#### A9. No logging for tolerance-matched blockchain verifications
- **Files:** `app/lib/blockchain-verify.ts:292-293`
- **Description:** 100-sat tolerance matches are accepted silently. No audit trail for systematic underpayment detection.
- **Fix:** Log when `amountMatches` passes due to tolerance.
- **Effort:** Quick fix

#### A10. Dead admin server actions may still exist
- **Files:** `app/admin/page.tsx`, `app/actions/admin.ts`
- **Description:** Admin page removed `grantBSV`, `resetUserBalance`, `advanceBlocks`, `setBlockHeight` UI, but the server actions may still be callable.
- **Fix:** Remove or deprecate unused server actions.
- **Effort:** Quick fix

---

## Phase 4: Code Quality

### HIGH

#### Q1. Wallet adapter utility methods fully duplicated (~150 lines)
- **Files:** `app/lib/wallet/brc100-adapter.ts`, `app/lib/wallet/simplysats-adapter.ts`
- **Description:** 6 identical private methods: `withTimeout`, `buildInscriptionScript`, `pushData`, `hash160`, `decodeBase58Check`, `createP2PKHLockingScript`.
- **Fix:** Extract to shared `wallet-utils.ts`.
- **Effort:** Medium refactor

#### Q2. Zero test coverage for wallet adapters
- **Files:** `app/lib/wallet/`
- **Description:** ~1500 lines of code handling real BSV transactions with no tests. Pure utility functions are highly testable.
- **Fix:** Unit tests for utility methods. Mock WalletClient for flow tests.
- **Effort:** Major change

### MEDIUM

#### Q3. TX status UI pattern duplicated across LockForm and SaleActions
- **Description:** Identical `txStatus` state type, `getStatusMessage()` function, and spinner SVG markup.
- **Fix:** Extract `TxStatusIndicator` component and `useTxStatus()` hook.
- **Effort:** Medium refactor

#### Q4. Spinner SVG duplicated ~9 times across codebase
- **Fix:** Extract `<Spinner />` component.
- **Effort:** Quick fix

#### Q5. `mountedRef` pattern repeated in 4 components
- **Fix:** Extract `useMountedRef()` hook.
- **Effort:** Quick fix

#### Q6. `currentWallet!` non-null assertion unsafe after connect
- **Files:** `app/post/[id]/SaleActions.tsx:99`, `app/components/LockForm.tsx:75`
- **Fix:** Add defensive null check after connect.
- **Effort:** Quick fix

#### Q7. `any[]` type in queries.ts
- **Files:** `app/actions/posts/queries.ts:37`
- **Fix:** Replace with `Prisma.PostWhereInput[]`.
- **Effort:** Quick fix

#### Q8. Deprecated `keyCode` usage in SatsInput
- **Files:** `app/components/SatsInput.tsx:74,78`
- **Fix:** Replace with `e.key` checks.
- **Effort:** Quick fix

#### Q9. `getBalance()` makes 5+ sequential network requests
- **Files:** `app/lib/wallet/brc100-adapter.ts:207-260`
- **Fix:** Use `Promise.allSettled()` for parallel queries.
- **Effort:** Quick fix

#### Q10. No tests for `rate-limit-core.ts`
- **Files:** `app/lib/rate-limit-core.ts`
- **Fix:** Add tests covering in-memory fallback, window expiry, IP extraction.
- **Effort:** Medium refactor

#### Q11. Form error/status messages lack aria-live regions
- **Files:** `app/components/LockForm.tsx`, `app/components/TipForm.tsx`, `app/post/[id]/SaleActions.tsx`
- **Fix:** Add `role="alert"` to errors, `aria-live="polite"` to status indicators.
- **Effort:** Quick fix

#### Q12. MobileDrawer missing dialog ARIA attributes
- **Files:** `app/components/MobileDrawer.tsx:50-53`
- **Fix:** Add `role="dialog"`, `aria-modal="true"`, focus trapping.
- **Effort:** Medium refactor

### LOW

#### Q13. `getNetwork` return type uses unsafe cast
- **Files:** `app/lib/wallet/simplysats-adapter.ts:667`

#### Q14. LockForm custom duration button lacks `aria-label`
- **Files:** `app/components/LockForm.tsx:249-262`

#### Q15. Duration preset buttons missing `aria-pressed`
- **Files:** `app/components/LockForm.tsx:233-248`

#### Q16. Sidebar composite key could collide
- **Files:** `app/components/Sidebar.tsx`

---

## Summary

| Severity | Count | Key Themes |
|----------|-------|------------|
| CRITICAL | 6 | Stale wallet crashes (B1, B2), SSRF via txid (S1), SatsInput unusable (B3), buy flow fund loss (A1), dead code (A2) |
| HIGH | 12 | TOCTOU payment redirection (S2), session TTL (S3, S4), dev breakage (B4), NaN bypass (B5), verify bug (B6), duplicate Redis (A3), missing mountedRef (A4), fail-open stores (A5), wallet adapter duplication (Q1), no wallet tests (Q2) |
| MEDIUM | 19 | Double-submit (S5), rate limit bypass (S6, S7), tolerance exploit (S8), test gaps (B7, Q10), error handling (B8, B9), DRY violations (Q3-Q5), type safety (Q6-Q8), performance (Q9), accessibility (Q11, Q12), architecture (A6-A10) |
| LOW | 7 | Logging (S9, S10), docstring (B10), unsafe cast (Q13), aria labels (Q14, Q15), key collision (Q16) |

**Total: 44 findings** (6 critical, 12 high, 19 medium, 7 low)

---

## Positive Changes in This Diff

1. **Session secret hardening**: Removed dev fallback secrets, fail-fast on missing `SESSION_SECRET`
2. **Password policy upgrade**: Minimum length 8→12, expanded common password blocklist
3. **Username regex validation**: `^[a-zA-Z0-9_-]+$` prevents injection
4. **Rate limiting on uploads/verification**: Previously unprotected endpoints now covered
5. **Information leakage reduction**: Blockchain verification errors no longer expose on-chain details to clients
6. **Lock verification cap**: `MAX_LOCKS_TO_VERIFY = 50` prevents DoS
7. **Console log → debug**: Operational messages downgraded in wallet adapters
8. **Rate limit consolidation**: Duplicated logic extracted into `rate-limit-core.ts`
9. **Admin page hardening**: Removed dangerous capabilities (`grantBSV`, `resetUserBalance`, etc.)
10. **React lifecycle fixes**: `mountedRef` guards in LockForm, TipForm; upload ID tracking in ImageUploadSection
11. **Distributed idempotency**: Upgraded from in-memory to Redis-backed distributed locking
12. **Recipient format validation**: Hex-only and length validation in blockchain-verify

---

## Prioritized Remediation Plan

### Immediate (Before Next Release)

| # | Issue | IDs | Effort |
|---|-------|-----|--------|
| 1 | Fix stale `currentWallet` crash in SaleActions and LockForm | B1, B2, Q6 | Quick fix |
| 2 | Add hex-only txid validation | S1 | Quick fix |
| 3 | Fix SatsInput max=0 clamping | B3 | Quick fix |
| 4 | Add try/catch to `handleList`/`handleCancel` | B9 | Quick fix |
| 5 | Add `mountedRef` to SaleActions | A4 | Quick fix |
| 6 | Add wallet-session secret length validation | S4 | Quick fix |
| 7 | Remove dead `isRedisAvailable()` | A2 | Quick fix |
| 8 | Set `loading` early in `handleBuy` | S5 | Quick fix |

### Short-Term (Next Sprint)

| # | Issue | IDs | Effort |
|---|-------|-----|--------|
| 9 | Move `sellerAddress` lookup server-side | S2 | Medium refactor |
| 10 | Add buy-flow recovery (persist txid, display on error) | A1 | Medium refactor |
| 11 | Reduce wallet session TTL, enforce `connectedAt` | S3 | Medium refactor |
| 12 | Consolidate Redis clients | A3 | Quick fix |
| 13 | Fix `fullyVerified` for >50 locks | B6 | Quick fix |
| 14 | Add `isNaN` check for custom blocks | B5 | Quick fix |
| 15 | Fix `router.refresh()` in finally block | B8 | Quick fix |
| 16 | Fail-closed rate limiting in production | S6, A5 | Quick fix |

### Medium-Term (Hardening)

| # | Issue | IDs | Effort |
|---|-------|-----|--------|
| 17 | Extract shared wallet utilities | Q1 | Medium refactor |
| 18 | Write wallet adapter tests | Q2 | Major change |
| 19 | Write rate-limit-core tests | Q10 | Medium refactor |
| 20 | Add aria-live regions to transaction forms | Q11 | Quick fix |
| 21 | Fix MobileDrawer ARIA/focus trapping | Q12 | Medium refactor |
| 22 | Extract `useMountedRef`, `TxStatusIndicator`, `Spinner` | Q3-Q5 | Medium refactor |
| 23 | Fix deprecated `keyCode` usage | Q8 | Quick fix |
| 24 | Parallelize `getBalance()` network requests | Q9 | Quick fix |
| 25 | Validate rate limit proxy headers | S7 | Medium refactor |
| 26 | Update password-policy docstring and tests | B7, B10 | Quick fix |
| 27 | Remove dead admin server actions | A10 | Quick fix |
