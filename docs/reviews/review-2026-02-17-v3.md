# Code Review — Wrootz BRC-100 (Review #6)
**Date:** 2026-02-17
**Reviewer:** Claude Sonnet 4.6
**Baseline:** 0 lint errors · 0 type errors · 89/89 tests passing
**Overall Rating: 7.5/10**

---

## Summary

Codebase is in solid shape with strong fundamentals: consistent auth patterns, idempotency
protection, bcrypt hashing, CSP policy, file magic-number validation, and parameterized DB
queries via Prisma. Main gaps are unmount safety for async polling, inscription retry
resilience, and some medium-priority security hardening. All P0 items from previous reviews
were already resolved before this session.

---

## Fixes Applied This Session

| Issue | File | Change |
|-------|------|--------|
| BG1 — Modal avatar state stale on reopen | `app/components/EditProfileButton.tsx:26` | Added `setAvatarUrl`, `setAvatarPreview`, `setPendingFile` resets in `isOpen` effect |
| BG4 — ProfilePageClient polling sets state after unmount | `app/profile/ProfilePageClient.tsx` | Added `useMountedRef` + mount guard before state updates in `fetchData` |
| BG5 — MyLocks handleUnlock sets state after unmount | `app/components/MyLocks.tsx:53` | Added `useMountedRef` + mount checks in all branches of `handleUnlock` |
| A1 — verifyInscription no retry on WhatsOnChain timeout | `app/actions/posts/create.ts:88` | Added retry loop (max 2 retries, 1.5s/3s backoff) |
| S8 — Fixed 100-sat lock tolerance exploitable on small amounts | `app/lib/blockchain-verify.ts:296` | Changed to `Math.max(100, Math.round(expectedSatoshis * 0.005))` |

**Post-fix verification:** 0 lint · 0 type errors · 89/89 tests ✓

---

## Phase 1 — Security

### Pre-fixed (confirmed present in codebase before this session)
- SSRF via txid: `/^[0-9a-f]{64}$/i` validation at `blockchain-verify.ts:70` ✓
- Seller address TOCTOU: `getSellerAddress(postId)` server-side fetch at `SaleActions.tsx:120` ✓
- CRON_SECRET optional: both cron routes return 500 in production if unset ✓
- Wallet session secret length: `wallet-session.ts:32` validates `secret.length < 32` ✓
- Double-submit race: `setLoading(true)` at top of `handleBuy` before wallet checks ✓

### Fixed This Session
- **S8** — Lock amount tolerance now `Math.max(100, expectedSatoshis * 0.005)` prevents underpayment on small locks

### Open
| ID | Issue | File | Severity |
|----|-------|------|----------|
| S3 | Wallet session TTL 8h; `connectedAt` stored but not enforced | `wallet-session.ts:45` | MEDIUM |
| S6 | Rate limit in-memory fallback fails open in serverless | `rate-limit-core.ts:27` | MEDIUM |
| S7 | IP extraction trusts spoofable `x-forwarded-for`/`x-real-ip` | `rate-limit-core.ts:119` | MEDIUM |
| H1 | Identity public keys stored in localStorage (XSS-accessible) | `brc100-adapter.ts:109` | LOW-MEDIUM |

---

## Phase 2 — Bugs

### Fixed This Session
- BG1, BG4, BG5 (see table above)

### Pre-fixed
- B1/B2 — stale closure crash: `connect()` returns `{ wallet }` ✓

### Open
| ID | Issue | File | Severity |
|----|-------|------|----------|
| BG2 | WalletProvider listener cleanup array cleared before async setup | `WalletProvider.tsx:80` | MEDIUM |
| BG6 | FeedClient dedup re-renders full list when only `totalTu` changes | `FeedClient.tsx:49` | LOW |
| BG7 | `parseInt('')` → NaN in LockForm block time estimate | `LockForm.tsx:278` | LOW |
| BG8 | Admin `Promise.all` partial failure leaves dashboard inconsistent | `admin/page.tsx:79` | LOW |

---

## Phase 3 — Architecture

### Fixed This Session
- A1 — `verifyInscription()` now retried up to 3× with backoff

### Open
| ID | Issue | File | Severity |
|----|-------|------|----------|
| A2 | Sidebar aggregations (`getTopTags` etc.) hit DB on every page load | `Sidebar.tsx`, `layout.tsx` | HIGH |
| A3 | Lock updater distributed lock TTL 120s — concurrent update if batch > TTL | `lock-updater.ts:74` | MEDIUM |
| A4 | Inconsistent API error shapes across routes | `feed/route.ts`, `posts/[id]/route.ts` | LOW |
| A5 | WalletProvider spreads full state — any change re-renders all consumers | `WalletProvider.tsx:206` | LOW |
| A6 | Rising/discover feed filters return unbounded result sets | `queries.ts:148` | LOW |

---

## Phase 4 — Code Quality

### Open
| ID | Issue | File | Severity |
|----|-------|------|----------|
| Q1 | Zero tests for `lock-updater.ts` (370 lines of complex batch logic) | `lock-updater.ts` | HIGH |
| Q2 | Zero tests for `queries.ts` feed filter logic (520 lines) | `queries.ts` | HIGH |
| Q3 | No E2E tests for create-post / buy-post flows | — | HIGH |
| Q4 | `PostWithRelations = any` bypasses Prisma type safety | `queries.ts:262` | MEDIUM |
| Q5 | Non-null assertion `.match(/.{2}/g)!` in hex parsing | `blockchain-verify.ts`, `wallet-utils.ts` | MEDIUM |
| Q6 | YouTube video ID extraction duplicated across components | `PostCard.tsx:10` | LOW |
| Q7 | Wallet dropdown lacks focus management on open | `WalletButton.tsx:66` | LOW |

---

## Recommended Next Steps

**High (next sprint)**
1. A2 — Cache sidebar aggregations in Redis (5-min TTL); eliminates 3 DB queries per page load
2. Q1/Q2 — Add unit tests for `lock-updater.ts` and `queries.ts`

**Medium (following sprint)**
3. S3 — Reduce wallet session TTL to 2h; enforce absolute `connectedAt` max
4. BG2 — Fix WalletProvider listener cleanup race
5. Q4 — Replace `PostWithRelations = any` with `Prisma.PostGetPayload<...>`

**Low (backlog)**
6. Q3 — Playwright E2E for create-post and buy-post
7. A5 — Split WalletProvider into state/actions contexts
8. S6/S7 — Rate limiting: fail closed in serverless; trust only CF-Connecting-IP
